<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p><strong>Chatbox</strong> is a websockets-based chat room built on
<a href="http://nodejs.org">node.js</a> and <a href="http://socket.io">socket.io</a>. You can see
chatbox in action at <a href="http://dpritchett.no.de">dpritchett.no.de</a> thanks to 
free no.de hosting by <a href="http://no.de">Joyent</a>.</p>

<p>Use <a href="http://npmjs.org/">npm</a> to install the packages by name:</p>

<pre><code>npm install socket.io uuid connect
</code></pre>

<p>Development begun September 2010 as a JavaScript exploration.</p>

<h3>Contacts:</h3>

<ul>
<li><a href="mailto:daniel@sharingatwork.com">daniel@sharingatwork.com</a></li>
<li><a href="http://github.com/dpritchett">github.com/dpritchett</a></li>
<li><a href="http://twitter.com/dpritchett">@dpritchett</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <h2>Includes and globals</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">PORT</span>        <span class="o">=</span> <span class="mi">80</span>
<span class="nx">DB_SERVER</span>   <span class="o">=</span> <span class="s1">&#39;dpritchett.couchone.com&#39;</span>
<span class="nx">DB_PORT</span>     <span class="o">=</span> <span class="mi">80</span>

<span class="nx">Connect</span>     <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;connect&#39;</span>
<span class="nx">sys</span>         <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;sys&#39;</span>
<span class="nx">uuid</span>        <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;uuid&#39;</span>
<span class="nx">io</span>          <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;socket.io&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>We're currently logging to a couchdb on <a href="http://couchdb.com">couchone.com</a>
even though we're not yet pulling out any data.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">couchdb</span>     <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;couchdb&#39;</span>
<span class="nx">couchClient</span> <span class="o">=</span> <span class="nx">couchdb</span><span class="p">.</span><span class="nx">createClient</span> <span class="nx">DB_PORT</span><span class="p">,</span> <span class="nx">DB_SERVER</span>
<span class="nx">db</span>          <span class="o">=</span> <span class="nx">couchClient</span><span class="p">.</span><span class="nx">db</span> <span class="s1">&#39;chatbox&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <h2>Service initialization</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>Create an instance of the Connect middleware, serving static files
out of /public an /docs.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span> <span class="o">=</span> <span class="nx">Connect</span><span class="p">.</span><span class="nx">createServer</span> <span class="p">(</span>

    <span class="nx">Connect</span><span class="p">.</span><span class="nx">logger</span><span class="p">()</span>

    <span class="nx">Connect</span><span class="p">.</span><span class="nx">staticProvider</span> <span class="s2">&quot;#{__dirname}/public&quot;</span>

    <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;Hello World&#39;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>

    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>Listen on http://localhost:80 by default but allow command line
args to override to e.g. http://dpritchett.no.de.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">PORT</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Listening on port #{PORT} with backend at #{DB_SERVER}: #{DB_PORT}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>This userlist allows us to keep track of who's online and which names map to 
which client.sessionId.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">names</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nx">users</span> <span class="o">=</span>

    <span class="nv">getName: </span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">names</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>

    <span class="nv">setName: </span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">newval</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">oldval</span> <span class="o">=</span> <span class="nx">names</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
        <span class="nx">names</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newval</span>
        <span class="k">return</span> <span class="s2">&quot;joined: #{names[id]}&quot;</span> <span class="nx">unless</span> <span class="nx">oldval</span><span class="o">?</span>
        <span class="k">return</span> <span class="s2">&quot;#{oldval} is now #{newval}&quot;</span> <span class="k">if</span> <span class="nx">oldval</span> <span class="o">isnt</span> <span class="nx">newval</span>
        <span class="s1">&#39;&#39;</span>

    <span class="nv">destroy: </span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">delete</span> <span class="nx">names</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>

    <span class="nv">list: </span><span class="o">-&gt;</span>
        <span class="p">(</span><span class="nx">val</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">names</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39; &#39;</span>

<span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>Socket.io hooks into the server above and intercepts socket communications.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">server</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <h2>Client handling logic: on connect, on message, on disconnect</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>Send an initial welcome message.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span> <span class="o">=</span>
        <span class="nv">name: </span><span class="s2">&quot;chatbot&quot;</span><span class="p">,</span>
        <span class="nv">content: </span><span class="s2">&quot;Welcome to chatbox! Other users online: #{users.list() or &#39;none.&#39;}&quot;</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">send</span> <span class="nx">json</span> <span class="nx">response</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>Process incoming messages as either name changes or chat text.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <p>System messages aren't rebroadcast directly.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">message</span><span class="p">.</span><span class="nx">system</span><span class="o">?</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">users</span><span class="p">.</span><span class="nx">setName</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">name</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span> <span class="nx">json</span> <span class="nx">response</span>
            <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <p>User chat is logged to couchdb.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">db</span><span class="p">.</span><span class="nx">saveDoc</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">generate</span><span class="p">(),</span> <span class="nx">message</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ok</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nx">unless</span> <span class="nx">err</span><span class="o">?</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">broadcast</span> <span class="nx">json</span> <span class="nx">message</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;Wrote to couch: #{sys.inspect message}&quot;</span>
            <span class="k">else</span>   <span class="c1">#if error</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;DB error on input: #{sys.inspect message } #{sys.inspect err }&quot;</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="nx">err</span>
            <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <p>Notify other chatters upon any disconnects.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="s2">&quot;#{users.getName(client.sessionId)} disconnected&quot;</span>

        <span class="nx">client</span><span class="p">.</span><span class="nx">broadcast</span> <span class="nx">json</span> <span class="nx">response</span>
        <span class="nx">users</span><span class="p">.</span><span class="nx">destroy</span> <span class="nx">client</span><span class="p">.</span><span class="nx">sessionId</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 